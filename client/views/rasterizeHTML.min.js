/*! rasterizeHTML.js - v0.8.0 - 2014-03-01
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2014 Christoph Burgmer; Licensed MIT */
!function(a,b){"object"==typeof exports?module.exports=b(require("url"),require("xmlserializer"),require("cssom"),require("ayepromise")):"function"==typeof define&&define.amd?define(["url","xmlserializer","cssom","ayepromise"],b):a.rasterizeHTML=b(a.url,a.xmlserializer,a.cssom,a.ayepromise)}(this,function(a,b,c,d){var e=function(a,b,c){"use strict";var d={};d.getDocumentBaseUrl=function(a){return"about:blank"!==a.baseURI?a.baseURI:null},d.clone=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c},d.cloneArray=function(a){return Array.prototype.slice.apply(a,[0])},d.joinUrl=function(a,b){return c.resolve(a,b)},d.isDataUri=function(a){return/^data:/.test(a)},d.all=function(a){var c=b.defer(),d=a.length,e=[];return 0===a.length?(c.resolve([]),c.promise):(a.forEach(function(a,b){a.then(function(a){d-=1,e[b]=a,0===d&&c.resolve(e)},function(a){c.reject(a)})}),c.promise)},d.collectAndReportErrors=function(a){var b=[];return d.all(a.map(function(a){return a.fail(function(a){b.push(a)})})).then(function(){return b})};var e=null,f=function(a,b){return b===!1||"none"===b||"repeated"===b?((null===e||"repeated"!==b)&&(e=Date.now()),a+"?_="+e):a};d.ajax=function(c,e){var g,h=new a.XMLHttpRequest,i=b.defer(),j=d.joinUrl(e.baseUrl,c),k=function(){i.reject({msg:"Unable to load url",url:j})};g=f(j,e.cache),h.addEventListener("load",function(){200===h.status||0===h.status?i.resolve(h.response):k()},!1),h.addEventListener("error",k,!1);try{h.open("GET",g,!0),h.overrideMimeType(e.mimeType),h.send(null)}catch(l){k()}return i.promise},d.binaryAjax=function(a,b){var c=d.clone(b);return c.mimeType="text/plain; charset=x-user-defined",d.ajax(a,c).then(function(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(255&a.charCodeAt(c));return b})};var g=function(a){var b=function(a,b){return a.substring(0,b.length)===b};return b(a,"<?xml")||b(a,"<svg")?"image/svg+xml":"image/png"};d.getDataURIForImageURL=function(a,b){return d.binaryAjax(a,b).then(function(a){var b=btoa(a),c=g(a);return"data:"+c+";base64,"+b})};var h=[],i=function(a){return h.indexOf(a)<0&&h.push(a),h.indexOf(a)};return d.memoize=function(a,b,c){if("object"!=typeof c)throw new Error("cacheBucket is not an object");return function(){var d,e=Array.prototype.slice.call(arguments),f=b(e),g=i(a);return c[g]&&c[g][f]?c[g][f]:(d=a.apply(null,e),c[g]=c[g]||{},c[g][f]=d,d)}},d}(window,d,a),f=function(a,b,c,d){"use strict";var e={},f=function(a,b,c){a.style.setProperty(b,c,a.style.getPropertyPriority(b))},g=function(a){var b,c=document.implementation.createHTMLDocument(""),d=document.createElement("style");return d.textContent=a,c.body.appendChild(d),b=d.sheet.cssRules,Array.prototype.slice.call(b)},h=function(){var a=g("a{background:url(i)}");return!a.length||a[0].cssText.indexOf("url()")>=0}();e.rulesForCssText=function(a){return h&&c.parse?c.parse(a).cssRules:g(a)};var i=function(a){return a.filter(function(a){return a.type===b.CSSRule.STYLE_RULE&&(a.style.getPropertyValue("background-image")||a.style.getPropertyValue("background"))})},j=function(a){var b=[];return a.forEach(function(a){a.style.getPropertyValue("background-image")?b.push({property:"background-image",value:a.style.getPropertyValue("background-image"),rule:a}):a.style.getPropertyValue("background")&&b.push({property:"background",value:a.style.getPropertyValue("background"),rule:a})}),b},k=function(a){return a.filter(function(a){return a.type===b.CSSRule.FONT_FACE_RULE&&a.style.getPropertyValue("src")})};e.cssRulesToText=function(a){return a.reduce(function(a,b){return a+b.cssText},"")};var l=function(a){var b=/^"(.*)"$/,c=/^'(.*)'$/;return b.test(a)?a.replace(b,"$1"):c.test(a)?a.replace(c,"$1"):a},m=function(a){var b=/^[\t\r\f\n ]*(.+?)[\t\r\f\n ]*$/;return a.replace(b,"$1")};e.extractCssUrl=function(a){var b,c=/^url\(([^\)]+)\)/;if(!c.test(a))throw new Error("Invalid url");return b=c.exec(a)[1],l(m(b))};var n=function(a){var b,c=/^format\(([^\)]+)\)/;return c.test(a)?(b=c.exec(a)[1],l(b)):null},o=function(a){var b,c=null;try{return b=e.extractCssUrl(a[0]),a[1]&&(c=n(a[1])),{url:b,format:c}}catch(d){}},p=function(a,b,c){var d="@font-face { font-family: "+b.style.getPropertyValue("font-family")+"; ";b.style.getPropertyValue("font-style")&&(d+="font-style: "+b.style.getPropertyValue("font-style")+"; "),b.style.getPropertyValue("font-weight")&&(d+="font-weight: "+b.style.getPropertyValue("font-weight")+"; "),d+="src: "+c+"}",q(a,b,d)},q=function(a,b,c){var d=a.indexOf(b),e=b.parentStyleSheet;e.insertRule(c,d+1),e.deleteRule(d),a[d]=e.cssRules[d]};e.adjustPathsOfCssResources=function(b,c){var d=i(c),e=j(d),g=!1;return e.forEach(function(c){var d,e=y(c.value),h=z(e);h.length>0&&(h.forEach(function(c){var d=e[c].url,f=a.joinUrl(b,d);e[c].url=f}),d=A(e),f(c.rule,c.property,d),g=!0)}),k(c).forEach(function(d){var e=d.style.getPropertyValue("src"),f=E(e),h=F(f);h.length>0&&(h.forEach(function(c){var d=f[c].url,e=a.joinUrl(b,d);f[c].url=e}),p(c,d,G(f)),g=!0)}),r(c).forEach(function(d){var e=d.href,f=a.joinUrl(b,e);q(c,d,"@import url("+f+");"),g=!0}),g};var r=function(a){return a.filter(function(a){return a.type===b.CSSRule.IMPORT_RULE&&a.href})},s=function(a,b,c){var d=a.indexOf(b);a.splice(d,1),c.forEach(function(b,c){a.splice(d+c,0,b)})},t=function(a){var b=/^"(.*)"$/,c=/^'(.*)'$/;return b.test(a)||c.test(a)},u=function(a){var b=d.defer();return b.resolve(a),b.promise},v=function(b,c,d,f){var g,h=c.href;return t(h)&&(h=l(h)),g=a.joinUrl(f.baseUrl,h),d.indexOf(g)>=0?(s(b,c,[]),u([])):(d.push(g),a.ajax(h,f).then(function(a){var g=e.rulesForCssText(a);return e.loadCSSImportsForRules(g,d,f).then(function(a){return e.adjustPathsOfCssResources(h,g),s(b,c,g),a.errors})},function(a){throw{resourceType:"stylesheet",url:a.url,msg:"Unable to load stylesheet "+a.url}}))};e.loadCSSImportsForRules=function(b,c,d){var e=r(b),f=[],g=!1;return a.all(e.map(function(a){return v(b,a,c,d).then(function(a){f=f.concat(a),g=!0},function(a){f.push(a)})})).then(function(){return{hasChanges:g,errors:f}})};var w=function(a){var b,c="\\s*(?:\"[^\"]*\"|'[^']*'|[^\\(]+)\\s*",d="(url\\("+c+"\\)|[^,\\s]+)",e="(?:\\s*"+d+")+",f="^\\s*("+e+")(?:\\s*,\\s*("+e+"))*\\s*$",g=new RegExp(e,"g"),h=[],i=function(a){var b,c=new RegExp(d,"g"),e=[];for(b=c.exec(a);b;)e.push(b[1]),b=c.exec(a);return e};if(a.match(new RegExp(f))){for(b=g.exec(a);b;)h.push(i(b[0])),b=g.exec(a);return h}return[]},x=function(a){var b,c;for(b=0;b<a.length;b++)try{return c=e.extractCssUrl(a[b]),{url:c,idx:b}}catch(d){}},y=function(a){var b=w(a);return b.map(function(a){var b=x(a);return b?{preUrl:a.slice(0,b.idx),url:b.url,postUrl:a.slice(b.idx+1)}:{preUrl:a}})},z=function(b){var c=[];return b.forEach(function(b,d){b.url&&!a.isDataUri(b.url)&&c.push(d)}),c},A=function(a){var b=a.map(function(a){var b=[].concat(a.preUrl);return a.url&&b.push('url("'+a.url+'")'),a.postUrl&&(b=b.concat(a.postUrl)),b.join(" ")});return b.join(", ")},B=function(b,c){var d=y(b),e=z(d),f=!1;return a.collectAndReportErrors(e.map(function(b){var e=d[b].url;return a.getDataURIForImageURL(e,c).then(function(a){d[b].url=a,f=!0},function(a){throw{resourceType:"backgroundImage",url:a.url,msg:"Unable to load background-image "+a.url}})})).then(function(a){return{backgroundValue:A(d),hasChanges:f,errors:a}})},C=function(b,c){var d=i(b),e=j(d),g=[],h=!1;return a.all(e.map(function(a){return B(a.value,c).then(function(b){b.hasChanges&&(f(a.rule,a.property,b.backgroundValue),h=!0),g=g.concat(b.errors)})})).then(function(){return{hasChanges:h,errors:g}})},D=function(a){var b,c="\\s*(?:\"[^\"]*\"|'[^']*'|[^\\(]+)\\s*",d="(local\\("+c+"\\))|(url\\("+c+"\\))(?:\\s+(format\\("+c+"\\)))?",e="^\\s*("+d+")(?:\\s*,\\s*("+d+"))*\\s*$",f=new RegExp(d,"g"),g=[],h=function(a){var b=[];return a.slice(1).forEach(function(a){a&&b.push(a)}),b};if(a.match(new RegExp(e))){for(b=f.exec(a);b;)g.push(h(b)),b=f.exec(a);return g}return[]},E=function(a){var b=D(a);return b.map(function(a){var b=o(a);return b?b:{local:a}})},F=function(b){var c=[];return b.forEach(function(b,d){b.url&&!a.isDataUri(b.url)&&c.push(d)}),c},G=function(a){return a.map(function(a){var b;return a.url?(b='url("'+a.url+'")',a.format&&(b+=' format("'+a.format+'")')):b=a.local,b}).join(", ")},H=function(b,c){var d=E(b),e=F(d),f=!1;return a.collectAndReportErrors(e.map(function(b){var e=d[b],g=e.format||"woff";return a.binaryAjax(e.url,c).then(function(a){var b=btoa(a);e.url="data:font/"+g+";base64,"+b,f=!0},function(a){throw{resourceType:"fontFace",url:a.url,msg:"Unable to load font-face "+a.url}})})).then(function(a){return{srcDeclarationValue:G(d),hasChanges:f,errors:a}})},I=function(b,c){var d=k(b),e=[],f=!1;return a.all(d.map(function(a){var d=a.style.getPropertyValue("src");return H(d,c).then(function(c){c.hasChanges&&(p(b,a,c.srcDeclarationValue),f=!0),e=e.concat(c.errors)})})).then(function(){return{hasChanges:f,errors:e}})};return e.loadAndInlineCSSResourcesForRules=function(b,c){var d=!1,e=[];return a.all([C,I].map(function(a){return a(b,c).then(function(a){d=d||a.hasChanges,e=e.concat(a.errors)})})).then(function(){return{hasChanges:d,errors:e}})},e}(e,window,c||{},d),g=function(a,b){"use strict";var c={},d=function(a){return b.joinUrl(a,".")},e=function(a){var b=a.map(function(b,c){return c===a.length-1&&(b={baseUrl:d(b.baseUrl)}),JSON.stringify(b)});return b},f=function(a,c){return c.cache!==!1&&"none"!==c.cache&&c.cacheBucket?b.memoize(a,e,c.cacheBucket):a},g=function(a,c){var d=a.attributes.src?a.attributes.src.nodeValue:null,e=b.getDocumentBaseUrl(a.ownerDocument),f=b.clone(c);return!f.baseUrl&&e&&(f.baseUrl=e),b.getDataURIForImageURL(d,f).then(function(a){return a},function(a){throw{resourceType:"image",url:a.url,msg:"Unable to load image "+a.url}})},h=function(a){return a.filter(function(a){var c=a.attributes.src?a.attributes.src.nodeValue:null;return null!==c&&!b.isDataUri(c)})},i=function(a){return Array.prototype.filter.call(a,function(a){return"image"===a.type})},j=function(a){return Array.prototype.slice.call(a)};c.loadAndInlineImages=function(a,c){var d=j(a.getElementsByTagName("img")),e=i(a.getElementsByTagName("input")),f=h(d.concat(e));return b.collectAndReportErrors(f.map(function(a){return g(a,c).then(function(b){a.attributes.src.nodeValue=b})}))};var k=function(b,c,d){var e=a.rulesForCssText(b);return a.loadCSSImportsForRules(e,c,d).then(function(c){return a.loadAndInlineCSSResourcesForRules(e,d).then(function(d){var f=c.errors.concat(d.errors),g=c.hasChanges||d.hasChanges;return g&&(b=a.cssRulesToText(e)),{hasChanges:g,content:b,errors:f}})})},l=function(a,c,d){var e=a.textContent,g=f(k,c);return g(e,d,c).then(function(c){return c.hasChanges&&(a.childNodes[0].nodeValue=c.content),b.cloneArray(c.errors)})},m=function(a){var b=a.getElementsByTagName("style");return Array.prototype.filter.call(b,function(a){return!a.attributes.type||"text/css"===a.attributes.type.nodeValue})};c.loadAndInlineStyles=function(a,c){var d,e=m(a),f=[],g=[];return d=b.clone(c),d.baseUrl=d.baseUrl||b.getDocumentBaseUrl(a),b.all(e.map(function(a){return l(a,d,g).then(function(a){f=f.concat(a)})})).then(function(){return f})};var n=function(a,b){var c,d=a.parentNode;b=b.trim(),b&&(c=a.ownerDocument.createElement("style"),c.type="text/css",c.appendChild(a.ownerDocument.createTextNode(b)),d.insertBefore(c,a)),d.removeChild(a)},o=function(c,d){return b.ajax(c,d).then(function(b){var c=a.rulesForCssText(b);return{content:b,cssRules:c}}).then(function(b){var d=a.adjustPathsOfCssResources(c,b.cssRules);return{content:b.content,cssRules:b.cssRules,hasChanges:d}}).then(function(b){return a.loadCSSImportsForRules(b.cssRules,[],d).then(function(a){return{content:b.content,cssRules:b.cssRules,hasChanges:b.hasChanges||a.hasChanges,errors:a.errors}})}).then(function(b){return a.loadAndInlineCSSResourcesForRules(b.cssRules,d).then(function(a){return{content:b.content,cssRules:b.cssRules,hasChanges:b.hasChanges||a.hasChanges,errors:b.errors.concat(a.errors)}})}).then(function(b){var c=b.content;return b.hasChanges&&(c=a.cssRulesToText(b.cssRules)),{content:c,errors:b.errors}})},p=function(a,c){var d=a.attributes.href.nodeValue,e=b.getDocumentBaseUrl(a.ownerDocument),g=b.clone(c);!g.baseUrl&&e&&(g.baseUrl=e);var h=f(o,c);return h(d,g).then(function(a){return{content:a.content,errors:b.cloneArray(a.errors)}})},q=function(a){var b=a.getElementsByTagName("link");return Array.prototype.filter.call(b,function(a){return a.attributes.rel&&"stylesheet"===a.attributes.rel.nodeValue&&(!a.attributes.type||"text/css"===a.attributes.type.nodeValue)})};c.loadAndInlineCssLinks=function(a,c){var d=q(a),e=[];return b.all(d.map(function(a){return p(a,c).then(function(b){n(a,b.content+"\n"),e=e.concat(b.errors)},function(a){e.push({resourceType:"stylesheet",url:a.url,msg:"Unable to load stylesheet "+a.url})})})).then(function(){return e})};var r=function(a,c){var d=a.attributes.src.nodeValue,e=b.getDocumentBaseUrl(a.ownerDocument),f=b.clone(c);return!f.baseUrl&&e&&(f.baseUrl=e),b.ajax(d,f).fail(function(a){throw{resourceType:"script",url:a.url,msg:"Unable to load script "+a.url}})},s=function(a){return a.replace(/<\//g,"<\\/")},t=function(a,b){a.attributes.removeNamedItem("src"),a.textContent=s(b)},u=function(a){var b=a.getElementsByTagName("script");return Array.prototype.filter.call(b,function(a){return!!a.attributes.src})};return c.loadAndInlineScript=function(a,c){var d=u(a);return b.collectAndReportErrors(d.map(function(a){return r(a,c).then(function(b){t(a,b)})}))},c.inlineReferences=function(a,d){var e=[],f=[c.loadAndInlineImages,c.loadAndInlineStyles,c.loadAndInlineCssLinks];return d.inlineScripts!==!1&&f.push(c.loadAndInlineScript),b.all(f.map(function(b){return b(a,d).then(function(a){e=e.concat(a)})})).then(function(){return e})},c}(f,e),h=function(a,b,c){"use strict";var d={},e=[];d={},d.getConstantUniqueIdFor=function(a){return e.indexOf(a)<0&&e.push(a),e.indexOf(a)};var f=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c},g=function(a){return"object"==typeof a&&null!==a},h=function(a){return g(a)&&Object.prototype.toString.apply(a).match(/\[object (Canvas|HTMLCanvasElement)\]/i)},i=function(a){return"function"==typeof a};d.parseOptionalParameters=function(a){var b={canvas:null,options:{},callback:null};return i(a[0])?b.callback=a[0]:null==a[0]||h(a[0])?(b.canvas=a[0]||null,i(a[1])?b.callback=a[1]:(b.options=f(a[1]),b.callback=a[2]||null)):(b.options=f(a[0]),b.callback=a[1]||null),b};var j=function(b,c){return function(){var d=new b,e=d.open;return d.open=function(){var b=Array.prototype.slice.call(arguments),d=b.shift(),f=b.shift(),g=a.joinUrl(c,f);return e.apply(this,[d,g].concat(b))},d}},k=function(a,b){var c=a.createElement(b);return c.style.visibility="hidden",c.style.width="0px",c.style.height="0px",c.style.position="absolute",c.style.top="-10000px",c.style.left="-10000px",a.getElementsByTagName("body")[0].appendChild(c),c};d.executeJavascript=function(a,d,e){var f=k(c.document,"iframe"),g=a.documentElement.outerHTML,h=[],i=b.defer(),l=function(){var a=f.contentDocument;c.document.getElementsByTagName("body")[0].removeChild(f),i.resolve({document:a,errors:h})};return f.onload=e>0?function(){setTimeout(l,e)}:l,f.contentDocument.open(),f.contentWindow.XMLHttpRequest=j(f.contentWindow.XMLHttpRequest,d),f.contentWindow.onerror=function(a){h.push({resourceType:"scriptExecution",msg:a})},f.contentDocument.write(g),f.contentDocument.close(),i.promise};var l=function(a,b,c){var d=a.createElement("iframe");return d.style.width=b+"px",d.style.height=c+"px",d.style.visibility="hidden",d.style.position="absolute",d.style.top=-1e4-c+"px",d.style.left=-1e4-b+"px",d.sandbox="allow-same-origin",a.getElementsByTagName("body")[0].appendChild(d),d};d.calculateDocumentContentSize=function(a,d,e){var f=a.documentElement.outerHTML,g=l(c.document,d,e),h=b.defer();return g.onload=function(){var a=g.contentDocument,b=Math.max(a.documentElement.scrollWidth,a.body.clientWidth),d=Math.max(a.documentElement.scrollHeight,a.body.scrollHeight,a.body.clientHeight);c.document.getElementsByTagName("body")[0].removeChild(g),h.resolve({width:b,height:d})},g.contentDocument.open(),g.contentDocument.write(f),g.contentDocument.close(),h.promise};var m=function(a,b){var d,e,f,g,h=/<html((?:\s+[^>]*)?)>/im.exec(b),i=c.document.implementation.createHTMLDocument("");if(h)for(d="<div"+h[1]+"></div>",i.documentElement.innerHTML=d,f=i.querySelector("div"),e=0;e<f.attributes.length;e++)g=f.attributes[e],a.documentElement.setAttribute(g.name,g.value)};d.parseHTML=function(a){var b;return(new DOMParser).parseFromString("<a></a>","text/html")?b=(new DOMParser).parseFromString(a,"text/html"):(b=c.document.implementation.createHTMLDocument(""),b.documentElement.innerHTML=a,m(b,a)),b};var n=function(a){var b=new DOMParser,c=b.parseFromString("<","text/xml"),d=c.getElementsByTagName("parsererror")[0].namespaceURI;return"http://www.w3.org/1999/xhtml"===d?a.getElementsByTagName("parsererror").length>0:a.getElementsByTagNameNS(d,"parsererror").length>0},o=function(a){if(n(a))throw{message:"Invalid source"}};d.validateXHTML=function(a){var b=new DOMParser,c=b.parseFromString(a,"application/xml");o(c)};var p=null,q=function(a,b){return b===!1||"none"===b||"repeated"===b?((null===p||"repeated"!==b)&&(p=Date.now()),a+"?_="+p):a},r=function(c,d){var e=new window.XMLHttpRequest,f=a.joinUrl(d.baseUrl,c),g=q(f,d.cache),h=b.defer(),i=function(){h.reject({message:"Unable to load page"})};e.addEventListener("load",function(){200===e.status||0===e.status?h.resolve(e.responseXML):i()},!1),e.addEventListener("error",function(){i()},!1);try{e.open("GET",g,!0),e.responseType="document",e.send(null)}catch(j){i()}return h.promise};d.loadDocument=function(a,b){return r(a,b).then(function(a){return o(a),a})},d.addClassNameRecursively=function(a,b){a.className+=" "+b,a.parentNode!==a.ownerDocument&&d.addClassNameRecursively(a.parentNode,b)};var s=function(a,b){var c=a.parentStyleSheet,d=Array.prototype.indexOf.call(c.cssRules,a);c.insertRule(b,d+1),c.deleteRule(d)},t=function(a,b){var c=a.cssText.replace(/^[^\{]+/,""),d=b+" "+c;s(a,d)},u=function(a){return Array.prototype.reduce.call(a,function(a,b){return a+b.cssText},"")},v=function(a){a.textContent=u(a.sheet.cssRules)};return d.rewriteStyleRuleSelector=function(a,b,c){var d=b+"(?=\\W|$)";Array.prototype.forEach.call(a.querySelectorAll("style"),function(a){var b=Array.prototype.filter.call(a.sheet.cssRules,function(a){return a.selectorText&&new RegExp(d).test(a.selectorText)});b.length&&(b.forEach(function(a){var b=a.selectorText.replace(new RegExp(d,"g"),c);t(a,b)}),v(a))})},d.fakeHover=function(a,b){var c=a.querySelector(b),e="rasterizehtmlhover";c&&(d.addClassNameRecursively(c,e),d.rewriteStyleRuleSelector(a,":hover","."+e))},d.fakeActive=function(a,b){var c=a.querySelector(b),e="rasterizehtmlactive";c&&(d.addClassNameRecursively(c,e),d.rewriteStyleRuleSelector(a,":active","."+e))},d.persistInputValues=function(a){var b=Array.prototype.slice.call(a.querySelectorAll("input")),c=Array.prototype.slice.call(a.querySelectorAll("textarea")),d=function(a){return"checkbox"===a.type||"radio"===a.type};b.filter(d).forEach(function(a){a.checked?a.setAttribute("checked",""):a.removeAttribute("checked")}),b.filter(function(a){return!d(a)}).forEach(function(a){a.setAttribute("value",a.value)}),c.forEach(function(a){a.textContent=a.value})},d}(e,d,window),i=function(a,b,c,d){"use strict";var e={},f=function(){if(d.navigator.userAgent.indexOf("WebKit")>=0&&d.navigator.userAgent.indexOf("Chrome")<0)return!1;if(d.BlobBuilder||d.MozBlobBuilder||d.WebKitBlobBuilder)return!0;if(d.Blob)try{return new d.Blob(["<b></b>"],{type:"text/xml"}),!0}catch(a){return!1}return!1},g=function(a){var b,c="image/svg+xml;charset=utf-8",e=d.BlobBuilder||d.MozBlobBuilder||d.WebKitBlobBuilder;return e?(b=new e,b.append(a),b.getBlob(c)):new d.Blob([a],{type:c})},h=function(a){var b=d.URL||d.webkitURL||d;return f()?b.createObjectURL(g(a)):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)},i=function(a){var b=d.URL||d.webkitURL||d;f()&&b.revokeObjectURL(a)},j=function(a,b){var c=a.createElement(b);return c.style.visibility="hidden",c.style.width="0px",c.style.height="0px",c.style.position="absolute",c.style.top="-10000px",c.style.left="-10000px",a.getElementsByTagName("body")[0].appendChild(c),c},k=function(a,b){var c=a.getElementById(b);return c||(c=j(a,"div"),c.id=b),c},l="rasterizeHTML_js_FirefoxWorkaround",m=function(){var a=d.navigator.userAgent.match(/Firefox\/(\d+).0/);return!a||!a[1]||parseInt(a[1],10)<17},n=function(b,c){var e,f=a.getConstantUniqueIdFor(b),g=c?c.ownerDocument:d.document;m()&&(e=k(g,l+f),e.innerHTML=b,e.className=l)},o=function(a){d.navigator.userAgent.indexOf("WebKit")>=0&&Array.prototype.forEach.call(a.getElementsByTagName("style"),function(a){a.textContent="span {}\n"+a.textContent})},p=function(b,c){var e=a.getConstantUniqueIdFor(b),f=c?c.ownerDocument:d.document,g=f.getElementById(l+e);g&&g.parentNode.removeChild(g)};e.getSvgForDocument=function(c,d,e){var f;return o(c),f=b.serializeToString(c),a.validateXHTML(f),'<svg xmlns="http://www.w3.org/2000/svg" width="'+d+'" height="'+e+'"><foreignObject width="100%" height="100%">'+f+"</foreignObject></svg>"};var q=function(){return{message:"Error rendering page"}};e.renderSvg=function(a,b){var e,f,g=c.defer(),j=function(){f.onload=null,f.onerror=null},k=function(){e&&i(e),p(a,b)};return n(a,b),e=h(a),f=new d.Image,f.onload=function(){j(),k(),g.resolve(f)},f.onerror=function(){k(),g.reject(q())},f.src=e,g.promise},e.drawImageOnCanvas=function(a,b){try{b.getContext("2d").drawImage(a,0,0)}catch(c){throw q()}};var r=function(a,b){var c=300,d=200,e=a?a.width:c,f=a?a.height:d,g=void 0!==b.width?b.width:e,h=void 0!==b.height?b.height:f;return{width:g,height:h}};return e.drawDocumentImage=function(b,c,d){var f=r(c,d);return d.hover&&a.fakeHover(b,d.hover),d.active&&a.fakeActive(b,d.active),a.calculateDocumentContentSize(b,f.width,f.height).then(function(a){return e.getSvgForDocument(b,a.width,a.height)}).then(function(a){return e.renderSvg(a,c)})},e}(h,b,d,window),j=function(a,b,c,d){"use strict";var e={},f=function(a,c,d){return b.drawDocumentImage(a,c,d).then(function(a){return c&&b.drawImageOnCanvas(a,c),a})},g=function(b,e,g){var h,i=g.executeJsTimeout||0;return h=d.clone(g),h.inlineScripts=g.executeJs===!0,c.inlineReferences(b,h).then(function(c){return g.executeJs?a.executeJavascript(b,g.baseUrl,i).then(function(b){var d=b.document;return a.persistInputValues(d),{document:d,errors:c.concat(b.errors)}}):{document:b,errors:c}}).then(function(a){return f(a.document,e,g).then(function(b){return{image:b,errors:a.errors}})})};e.drawDocument=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c),e=g(b,d.canvas,d.options);return d.callback&&e.then(function(a){d.callback(a.image,a.errors)},function(){d.callback(null,[{resourceType:"document",msg:"Error rendering page"}])}),e};var h=function(b,c,d,f){var g=a.parseHTML(b);return e.drawDocument(g,c,d,f)};e.drawHTML=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return h(b,d.canvas,d.options,d.callback)};var i=function(b,c,d,f){var g=a.loadDocument(b,d).then(function(a){return e.drawDocument(a,c,d)});return f&&g.then(function(a){f(a.image,a.errors)},function(a){f(null,[{resourceType:"page",url:b,msg:a.message+" "+b}])}),g};return e.drawURL=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return i(b,d.canvas,d.options,d.callback)},e}(h,i,g,e);return j});